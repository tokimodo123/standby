<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Standby</title>
  <style>
    :root{
      --bg:#0a0f16;
      --fg:#e7eef7;
      --muted: rgba(231,238,247,.65);
      --panel: rgba(255,255,255,.07);
      --panel2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.12);
      --shadow: rgba(0,0,0,.28);
      --accent:#ff5473;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --fg:#0b1220;
      --muted: rgba(11,18,32,.58);
      --panel: rgba(0,0,0,.05);
      --panel2: rgba(0,0,0,.08);
      --border: rgba(0,0,0,.12);
      --shadow: rgba(0,0,0,.08);
      --accent:#ff2f5a;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Hiragino Sans", "Noto Sans JP", sans-serif;}
    body{overflow:hidden;}

    .wrap{
      position:fixed; inset:0;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      box-sizing:border-box;
    }
    .panel{
      border-radius: 24px;
      background: var(--panel);
      border: 1px solid var(--border);
      overflow:hidden;
      position:relative;
    }

    /* LEFT */
    .leftInner{
      height:100%;
      padding:18px;
      box-sizing:border-box;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:14px;
    }
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .digital{
      font-variant-numeric: tabular-nums;
      letter-spacing: .02em;
      line-height:1;
    }
    .digital .time{
      font-size: 112px;
      font-weight: 900;
    }
    .digital .date{
      margin-top:10px;
      font-size: 18px;
      color: var(--muted);
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--fg);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 10px 22px var(--shadow);
    }
    .btn:active{transform: translateY(1px);}

    .midRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .card{
      border-radius: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding:14px;
      box-sizing:border-box;
      min-height: 170px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      letter-spacing: .06em;
    }
    .analogWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      height: calc(100% - 22px);
    }
    .clockSvg{
      width: min(280px, 22vw);
      height: auto;
      filter: drop-shadow(0 10px 22px var(--shadow));
    }
    .dial{
      fill: transparent;
      stroke: var(--border);
      stroke-width: 2;
    }
    .face{
      fill: rgba(0,0,0,.22);
    }
    html[data-theme="light"] .face{ fill: rgba(255,255,255,.50); }

    .tick{stroke: rgba(255,255,255,.35); stroke-width: 2;}
    .tickBig{stroke: rgba(255,255,255,.55); stroke-width: 3;}
    html[data-theme="light"] .tick{stroke: rgba(0,0,0,.30);}
    html[data-theme="light"] .tickBig{stroke: rgba(0,0,0,.45);}

    .handH{stroke: var(--fg); stroke-width: 8; stroke-linecap: round;}
    .handM{stroke: var(--fg); stroke-width: 6; stroke-linecap: round; opacity:.95;}
    .handS{stroke: var(--accent); stroke-width: 3; stroke-linecap: round; opacity:.95;}
    .pin{fill: var(--fg); opacity:.9;}

    .wxMain{display:flex; align-items:center; gap:12px;}
    .wxIcon{font-size:34px; width:40px; text-align:center;}
    .wxTemp{font-size:30px; font-weight:900; line-height:1;}
    .wxPlace{margin-top:6px; font-size:14px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .wxDetail{margin-top:6px; font-size:12px; color:var(--muted);}
    .wxMeta{margin-top:12px; font-size:12px; color:var(--muted);}

    /* RIGHT */
    #scene{position:absolute; inset:0; width:100%; height:100%;}
    .rightBtns{
      position:absolute;
      right:14px;
      bottom:14px;
      display:flex;
      gap:10px;
      z-index:5;
    }

    @media (max-width: 980px){
      .digital .time{font-size: 86px;}
      .midRow{grid-template-columns: 1fr;}
      .clockSvg{width:min(300px, 44vw);}
      .controls{flex-direction:row;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- LEFT -->
    <section class="panel">
      <div class="leftInner">
        <div class="topRow">
          <div class="digital">
            <div class="time" id="time">--:--</div>
            <div class="date" id="date">----</div>
          </div>
          <div class="controls">
            <button class="btn" id="themeBtn">ãƒ›ãƒ¯ã‚¤ãƒˆ</button>
            <button class="btn" id="chatBtn">ChatGPT</button>
          </div>
        </div>

        <div class="midRow">
          <div class="card">
            <div class="label">ANALOG</div>
            <div class="analogWrap">
              <svg class="clockSvg" viewBox="0 0 200 200" aria-label="analog clock">
                <circle cx="100" cy="100" r="90" class="face"></circle>
                <circle cx="100" cy="100" r="92" class="dial"></circle>
                <g id="ticks"></g>
                <g transform="translate(100 100)">
                  <line id="handH" x1="0" y1="10" x2="0" y2="-42" class="handH"></line>
                  <line id="handM" x1="0" y1="14" x2="0" y2="-62" class="handM"></line>
                  <line id="handS" x1="0" y1="18" x2="0" y2="-70" class="handS"></line>
                  <circle r="6" class="pin"></circle>
                </g>
              </svg>
            </div>
          </div>

          <div class="card">
            <div class="label">WEATHER</div>
            <div class="wxMain">
              <div class="wxIcon" id="wxIcon">â›…ï¸</div>
              <div>
                <div class="wxTemp" id="wxTemp">--Â°C</div>
                <div class="wxPlace" id="wxPlace">å¤©æ°—å–å¾—å¾…ã¡</div>
                <div class="wxDetail" id="wxDetail">â€”</div>
              </div>
            </div>
            <div class="wxMeta" id="wxMeta">â€”</div>
          </div>
        </div>

        <div style="flex:1"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <canvas id="scene"></canvas>
      <div class="rightBtns">
        <button class="btn" id="wxBtn">å¤©æ°—æ›´æ–°</button>
      </div>
    </section>
  </div>

<script>
(function(){
  // ====== Safe storage (iOSã§ä¾‹å¤–ãŒå‡ºã¦ã‚‚æ­¢ã¾ã‚‰ãªã„) ======
  function storageGet(key){
    try { return localStorage.getItem(key); } catch(e){ return null; }
  }
  function storageSet(key, val){
    try { localStorage.setItem(key, val); } catch(e){}
  }

  // ====== Theme ======
  var themeKey = "standby_theme_v3";
  var root = document.documentElement;
  function applyTheme(t){
    root.setAttribute("data-theme", t);
    storageSet(themeKey, t);
    document.getElementById("themeBtn").textContent = (t === "light") ? "ãƒ€ãƒ¼ã‚¯" : "ãƒ›ãƒ¯ã‚¤ãƒˆ";
  }
  var saved = storageGet(themeKey);
  if(saved){
    applyTheme(saved);
  }else{
    var prefersLight = false;
    try { prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches; } catch(e){}
    applyTheme(prefersLight ? "light" : "dark");
  }
  document.getElementById("themeBtn").addEventListener("click", function(){
    var cur = root.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  // ====== Chat ======
  document.getElementById("chatBtn").addEventListener("click", function(){
    window.open("https://chatgpt.com", "_blank");
  });

  // ====== Digital + Analog clock ======
  var timeEl = document.getElementById("time");
  var dateEl = document.getElementById("date");
  var handH = document.getElementById("handH");
  var handM = document.getElementById("handM");
  var handS = document.getElementById("handS");
  var sceneHour = 12, sceneMin = 0, sceneSec = 0;

  function pad(n){ return (n<10 ? "0" : "") + n; }
  var dow = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

  function rot(el, deg){
    // SVG rotate uses element origin (0,0) inside translated group
    el.setAttribute("transform", "rotate(" + deg + ")");
  }

  // ticks create once
  (function(){
    var ticksG = document.getElementById("ticks");
    var s = "";
    for(var i=0;i<60;i++){
      var a = (Math.PI*2) * (i/60);
      var r1 = 80;
      var r2 = (i%5===0) ? 70 : 74;
      var x1 = 100 + Math.sin(a)*r1;
      var y1 = 100 - Math.cos(a)*r1;
      var x2 = 100 + Math.sin(a)*r2;
      var y2 = 100 - Math.cos(a)*r2;
      var cls = (i%5===0) ? "tickBig" : "tick";
      s += '<line x1="'+x1.toFixed(2)+'" y1="'+y1.toFixed(2)+'" x2="'+x2.toFixed(2)+'" y2="'+y2.toFixed(2)+'" class="'+cls+'" />';
    }
    ticksG.innerHTML = s;
  })();

  function updateAnalog(d){
    var h = d.getHours() % 12;
    var m = d.getMinutes();
    var s = d.getSeconds();
    var ms = d.getMilliseconds();

    var sec = s + ms/1000;
    var min = m + sec/60;
    var hour = h + min/60;

    rot(handS, sec*6);
    rot(handM, min*6);
    rot(handH, hour*30);
  }

  function tick(){
    var d = new Date();
    timeEl.textContent = pad(d.getHours()) + ":" + pad(d.getMinutes());
    dateEl.textContent = d.getFullYear()+"/"+pad(d.getMonth()+1)+"/"+pad(d.getDate())+" ("+dow[d.getDay()]+")";
    updateAnalog(d);
    sceneHour = d.getHours();
    sceneMin = d.getMinutes();
    sceneSec = d.getSeconds();
  }
  tick();
  setInterval(tick, 1000);

  // ====== Weather (å¿…ãšçµ‚ã‚ã‚‹ãƒ»å¿…ãšè¡¨ç¤ºã•ã‚Œã‚‹) ======
  var wxIconEl = document.getElementById("wxIcon");
  var wxTempEl = document.getElementById("wxTemp");
  var wxPlaceEl = document.getElementById("wxPlace");
  var wxDetailEl = document.getElementById("wxDetail");
  var wxMetaEl = document.getElementById("wxMeta");

  var currentWxCode = null; // for scene
  var currentWxWind = 0;

  function weatherEmoji(code){
    if(code===0) return "â˜€ï¸";
    if(code===1||code===2) return "ğŸŒ¤ï¸";
    if(code===3) return "â˜ï¸";
    if(code===45||code===48) return "ğŸŒ«ï¸";
    if(code===51||code===53||code===55||code===56||code===57) return "ğŸŒ¦ï¸";
    if(code===61||code===63||code===65||code===66||code===67) return "ğŸŒ§ï¸";
    if(code===71||code===73||code===75||code===77) return "ğŸŒ¨ï¸";
    if(code===80||code===81||code===82) return "ğŸŒ§ï¸";
    if(code===85||code===86) return "ğŸŒ¨ï¸";
    if(code===95||code===96||code===99) return "â›ˆï¸";
    return "â›…ï¸";
  }
  function codeText(code){
    var map = {
      0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§",
      51:"éœ§é›¨(å¼±)",53:"éœ§é›¨(ä¸­)",55:"éœ§é›¨(å¼·)",56:"å‡çµéœ§é›¨(å¼±)",57:"å‡çµéœ§é›¨(å¼·)",
      61:"é›¨(å¼±)",63:"é›¨(ä¸­)",65:"é›¨(å¼·)",66:"å‡çµé›¨(å¼±)",67:"å‡çµé›¨(å¼·)",
      71:"é›ª(å¼±)",73:"é›ª(ä¸­)",75:"é›ª(å¼·)",77:"éœ°(ã‚ã‚‰ã‚Œ)",
      80:"ã«ã‚ã‹é›¨(å¼±)",81:"ã«ã‚ã‹é›¨(ä¸­)",82:"ã«ã‚ã‹é›¨(å¼·)",
      85:"ã«ã‚ã‹é›ª(å¼±)",86:"ã«ã‚ã‹é›ª(å¼·)",
      95:"é›·é›¨",96:"é›·é›¨(é›¹)",99:"é›·é›¨(é›¹)"
    };
    return map[code] || ("å¤©æ°—ã‚³ãƒ¼ãƒ‰ " + code);
  }

  function setWx(state){
    wxTempEl.textContent = state.tempText || "--Â°C";
    wxPlaceEl.textContent = state.place || "â€”";
    wxDetailEl.textContent = state.detail || "â€”";
    wxMetaEl.textContent = state.meta || "â€”";
    wxIconEl.textContent = state.icon || "â›…ï¸";
    currentWxCode = (typeof state.code === "number") ? state.code : currentWxCode;
    currentWxWind = (typeof state.wind === "number") ? state.wind : currentWxWind;
  }

  function fetchWithTimeout(url, ms){
    return new Promise(function(resolve, reject){
      var done = false;
      var timer = setTimeout(function(){
        if(done) return;
        done = true;
        reject(new Error("timeout"));
      }, ms);

      fetch(url, {cache:"no-store"})
        .then(function(r){
          if(!r.ok) throw new Error("http");
          return r.json();
        })
        .then(function(j){
          if(done) return;
          done = true;
          clearTimeout(timer);
          resolve(j);
        })
        .catch(function(e){
          if(done) return;
          done = true;
          clearTimeout(timer);
          reject(e);
        });
    });
  }

  function updateWeatherWithCoords(lat, lon, placeText){
    var url =
      "https://api.open-meteo.com/v1/forecast?latitude="+lat+
      "&longitude="+lon+
      "&current=temperature_2m,weather_code,wind_speed_10m"+
      "&timezone=Asia%2FTokyo";

    return fetchWithTimeout(url, 9000).then(function(wx){
      var cur = wx && wx.current ? wx.current : null;
      if(!cur) throw new Error("baddata");
      var temp = Math.round(cur.temperature_2m);
      var code = cur.weather_code;
      var wind = Math.round(cur.wind_speed_10m);

      setWx({
        tempText: temp + "Â°C",
        place: placeText,
        detail: codeText(code) + " / é¢¨ " + wind + "m/s",
        meta: "æœ€çµ‚æ›´æ–°: " + new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),
        icon: weatherEmoji(code),
        code: code,
        wind: wind
      });
    });
  }

  function reverseGeocode(lat, lon){
    var url = "https://geocoding-api.open-meteo.com/v1/reverse?latitude="+lat+"&longitude="+lon+"&language=ja";
    return fetchWithTimeout(url, 9000).then(function(j){
      var p = j && j.results && j.results[0] ? j.results[0] : null;
      if(!p) return null;
      var parts = [];
      if(p.name) parts.push(p.name);
      if(p.admin1) parts.push(p.admin1);
      if(p.country) parts.push(p.country);
      return parts.join(", ");
    }).catch(function(){ return null; });
  }

  function fallbackTokyo(reason){
    // æ±äº¬é§…ä»˜è¿‘
    return updateWeatherWithCoords(35.681236, 139.767125, "æ±äº¬ï¼ˆ" + reason + "ï¼‰");
  }

  function updateWeather(){
    setWx({ place:"å¤©æ°—å–å¾—ä¸­â€¦", meta:"â€”", icon:"â›…ï¸" });

    // çµ¶å¯¾ã«ã€Œå–å¾—ä¸­â€¦ã€ã§å›ºã¾ã‚‰ãªã„ãŸã‚ã®ä¿é™º
    var hardTimeout = setTimeout(function(){
      fallbackTokyo("å–å¾—ãŒé•·å¼•ã„ãŸãŸã‚æ±äº¬ã‚’è¡¨ç¤º");
    }, 12000);

    function finish(){ clearTimeout(hardTimeout); }

    // geolocation â†’ reverseGeocode â†’ weather
    if(!navigator.geolocation){
      fallbackTokyo("ä½ç½®æƒ…å ±éå¯¾å¿œ").then(finish).catch(finish);
      return;
    }

    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;

      reverseGeocode(lat, lon).then(function(place){
        var label = place || ("lat " + lat.toFixed(2) + ", lon " + lon.toFixed(2));
        return updateWeatherWithCoords(lat, lon, label);
      }).then(finish).catch(function(){
        fallbackTokyo("å¤©æ°—APIå¤±æ•—").then(finish).catch(finish);
      });

    }, function(err){
      var reason = (err && err.code === 1) ? "ä½ç½®æƒ…å ±æ‹’å¦" : "ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼";
      fallbackTokyo(reason).then(finish).catch(finish);
    }, { enableHighAccuracy:false, timeout:8000, maximumAge: 10*60*1000 });
  }

  document.getElementById("wxBtn").addEventListener("click", function(){
    updateWeather();
  });

  updateWeather();
  setInterval(updateWeather, 10*60*1000);

  // ====== Right Scene ======
  var canvas = document.getElementById("scene");
  var ctx = canvas.getContext("2d", {alpha:true});

  function resize(){
    var r = window.devicePixelRatio || 1;
    var rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * r);
    canvas.height= Math.floor(rect.height* r);
    ctx.setTransform(r,0,0,r,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function lerp(a,b,t){ return a+(b-a)*t; }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function wxKind(code){
    if(code == null) return "unknown";
    if(code===0||code===1) return "clear";
    if(code===2||code===3) return "cloudy";
    if(code===45||code===48) return "fog";
    if(code===51||code===53||code===55||code===56||code===57) return "drizzle";
    if(code===61||code===63||code===65||code===66||code===67||code===80||code===81||code===82||code===95||code===96||code===99) return "rain";
    if(code===71||code===73||code===75||code===77||code===85||code===86) return "snow";
    return "cloudy";
  }

  // stars
  var stars = [];
  for(var i=0;i<120;i++){
    stars.push({x:((i*97)%1000)/1000, y:((i*173)%1000)/1000, s:((i*37)%7)+1});
  }
  // clouds
  var clouds = [];
  for(var c=0;c<9;c++){
    clouds.push({x:Math.random()*1.2-0.1, y:Math.random()*0.35+0.08, v:0.010+Math.random()*0.02, w:0.18+Math.random()*0.18});
  }
  // rain drops
  var drops = [];
  for(var d=0; d<190; d++){
    drops.push({x:Math.random(), y:Math.random(), v:0.8+Math.random()*1.2, l:0.015+Math.random()*0.02});
  }
  // snow flakes
  var flakes = [];
  for(var f=0; f<150; f++){
    flakes.push({x:Math.random(), y:Math.random(), v:0.12+Math.random()*0.25, s:0.004+Math.random()*0.008, w:(Math.random()*2-1)*0.10});
  }

  // walking human (pixel)
  function drawHuman(px, py, scale, frame, facing){
    var s = scale;
    function pixel(ix,iy,col){
      ctx.fillStyle = col;
      ctx.fillRect(px + ix*s, py + iy*s, s, s);
    }

    var isLight = (root.getAttribute("data-theme")==="light");
    var skin = isLight ? "#F2C9A0" : "#E7B98D";
    var hair = isLight ? "#2b2b2b" : "#141414";
    var shirt= isLight ? "#4f8cff" : "#6aa7ff";
    var pants= isLight ? "#2e3a4f" : "#1c2738";
    var shoe = isLight ? "#111" : "#090909";
    var bag  = isLight ? "#ffb703" : "#ffd166";

    var step = (Math.floor(frame)%2);

    // head (16x5)
    var head = [
      "....######......",
      "...########.....",
      "...########.....",
      "...########.....",
      "....######......"
    ];
    // body (16x6)
    var body = [
      "....####........",
      "...######.......",
      "...######.......",
      "...######.......",
      "...######.......",
      "....####........"
    ];
    // legs
    var legA = [
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "..##....##......"
    ];
    var legB = [
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "..##....##......",
      "...##..##......."
    ];
    var legs = (step===0) ? legA : legB;

    // draw
    for(var y=0; y<head.length; y++){
      for(var x=0; x<16; x++){
        if(head[y].charAt(x)==="#"){
          var col = (y<=1) ? hair : skin;
          pixel(x,y,col);
        }
      }
    }
    // eyes
    pixel(6,2,"#0b0b0b"); pixel(9,2,"#0b0b0b");

    var by0 = 6;
    for(var y2=0; y2<body.length; y2++){
      for(var x2=0; x2<16; x2++){
        if(body[y2].charAt(x2)==="#") pixel(x2, by0+y2, shirt);
      }
    }
    // arms
    pixel(4,8,skin); pixel(11,8,skin);
    pixel(3,9,skin); pixel(12,9,skin);

    // waist
    pixel(6,12,pants); pixel(7,12,pants); pixel(8,12,pants); pixel(9,12,pants);

    var ly0 = 13;
    for(var y3=0; y3<legs.length; y3++){
      for(var x3=0; x3<16; x3++){
        if(legs[y3].charAt(x3)==="#") pixel(x3, ly0+y3, pants);
      }
    }
    // shoes
    pixel(5,ly0+5,shoe); pixel(10,ly0+5,shoe);

    // bag
    pixel(2,9,bag); pixel(2,10,bag);
  }

  function skyParams(h){
    // 0..24
    var nightTop=[12,16,28], nightBot=[8,10,18];
    var mornTop=[120,175,255], mornBot=[240,210,160];
    var dayTop =[80,170,255], dayBot =[200,240,255];
    var setTop =[255,140,120], setBot=[80,50,120];

    function mix(c1,c2,k){
      return [lerp(c1[0],c2[0],k), lerp(c1[1],c2[1],k), lerp(c1[2],c2[2],k)];
    }

    var top, bot, nightness;
    if(h<5){
      top=nightTop; bot=nightBot; nightness=1;
    }else if(h<9){
      var k1=(h-5)/4;
      top=mix(nightTop,mornTop,k1);
      bot=mix(nightBot,mornBot,k1);
      nightness=1-k1;
    }else if(h<16){
      var k2=(h-9)/7;
      top=mix(mornTop,dayTop,k2);
      bot=mix(mornBot,dayBot,k2);
      nightness=0;
    }else if(h<19){
      var k3=(h-16)/3;
      top=mix(dayTop,setTop,k3);
      bot=mix(dayBot,setBot,k3);
      nightness=k3*0.6;
    }else{
      var k4=(h-19)/5;
      top=mix(setTop,nightTop,clamp(k4,0,1));
      bot=mix(setBot,nightBot,clamp(k4,0,1));
      nightness=0.6+0.4*clamp(k4,0,1);
    }
    return {top:top, bot:bot, nightness:nightness};
  }

  function bodyPos(p){
    // arc from left->right, highest in middle
    var x = lerp(0.08, 0.92, p);
    var y = 0.60 - Math.sin(p*Math.PI)*0.42;
    return {x:x, y:y};
  }

  var dude = { x:0.25, y:0.70, v:0.06, dir:1 };
  var t = 0;

  function draw(dt){
    t += dt;
    var rect = canvas.getBoundingClientRect();
    var W = rect.width, H = rect.height;

    var hourFloat = sceneHour + sceneMin/60 + sceneSec/3600;
    var sp = skyParams(hourFloat);

    // background gradient
    var g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgb("+(sp.top[0]|0)+","+(sp.top[1]|0)+","+(sp.top[2]|0)+")");
    g.addColorStop(1, "rgb("+(sp.bot[0]|0)+","+(sp.bot[1]|0)+","+(sp.bot[2]|0)+")");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // stars
    if(sp.nightness > 0.15){
      var base = clamp((sp.nightness-0.1)/0.9, 0, 1);
      for(var i=0;i<stars.length;i++){
        var st = stars[i];
        var tw = 0.35 + 0.65*(0.5+0.5*Math.sin(t*1.2 + st.s));
        ctx.globalAlpha = base * 0.65 * tw;
        ctx.fillStyle = "white";
        ctx.fillRect(st.x*W, st.y*H*0.65, 2, 2);
      }
      ctx.globalAlpha = 1;
    }

    // sun/moon positions
    var sunActive = (hourFloat >= 6 && hourFloat < 18);
    var progSun = clamp((hourFloat - 6)/12, 0, 1);
    var progMoon = clamp(((hourFloat >= 18 ? hourFloat : hourFloat+24) - 18)/12, 0, 1);

    var isLight = (root.getAttribute("data-theme")==="light");

    if(sunActive){
      var pS = bodyPos(progSun);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = isLight ? "rgba(255,210,120,.95)" : "rgba(255,214,140,.95)";
      ctx.beginPath(); ctx.arc(pS.x*W, pS.y*H, 22, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.22;
      ctx.beginPath(); ctx.arc(pS.x*W, pS.y*H, 55, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }else{
      var pM = bodyPos(progMoon);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = isLight ? "rgba(255,255,255,.92)" : "rgba(230,240,255,.90)";
      ctx.beginPath(); ctx.arc(pM.x*W, pM.y*H, 18, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.beginPath(); ctx.arc(pM.x*W+6, pM.y*H-4, 4, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    // ground
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = isLight ? "rgba(0,0,0,.52)" : "rgba(0,0,0,.65)";
    ctx.fillRect(0, H*0.78, W, H*0.22);
    ctx.globalAlpha = 1;

    // weather overlay
    var kind = wxKind(currentWxCode);

    // clouds/fog
    if(kind==="cloudy" || kind==="drizzle" || kind==="rain" || kind==="fog" || kind==="snow"){
      var baseAlpha = (kind==="fog") ? 0.55 : 0.28;
      ctx.globalAlpha = baseAlpha;
      for(var j=0;j<clouds.length;j++){
        var c = clouds[j];
        c.x += c.v * dt * (1 + (currentWxWind ? currentWxWind/20 : 0));
        if(c.x > 1.25) c.x = -0.25;
        var cx = c.x*W;
        var cy = c.y*H;
        var w  = c.w*W;
        var hh = w*0.35;
        ctx.fillStyle = isLight ? "rgba(255,255,255,.92)" : "rgba(255,255,255,.86)";
        ctx.beginPath();
        ctx.ellipse(cx, cy, w*0.28, hh*0.55, 0, 0, Math.PI*2);
        ctx.ellipse(cx+w*0.18, cy-hh*0.15, w*0.22, hh*0.50, 0, 0, Math.PI*2);
        ctx.ellipse(cx-w*0.18, cy-hh*0.10, w*0.24, hh*0.52, 0, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    // rain
    if(kind==="rain" || kind==="drizzle"){
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = isLight ? "rgba(0,0,0,.22)" : "rgba(255,255,255,.20)";
      ctx.lineWidth = 2;
      for(var k=0;k<drops.length;k++){
        var dr = drops[k];
        dr.y += dr.v * dt * 0.8;
        dr.x += 0.05 * dt;
        if(dr.y > 1){ dr.y = -Math.random()*0.2; dr.x = Math.random(); }
        if(dr.x > 1.1) dr.x = -0.1;
        var x = dr.x*W;
        var y = dr.y*H;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+8, y+H*dr.l);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
    }

    // snow
    if(kind==="snow"){
      ctx.globalAlpha = 0.65;
      ctx.fillStyle = isLight ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.86)";
      for(var q=0;q<flakes.length;q++){
        var fl = flakes[q];
        fl.y += fl.v * dt;
        fl.x += (fl.w * dt) + 0.02*Math.sin(t*0.6 + fl.y*10)*dt;
        if(fl.y > 1){ fl.y = -Math.random()*0.2; fl.x = Math.random(); }
        if(fl.x > 1.1) fl.x = -0.1;
        ctx.fillRect(fl.x*W, fl.y*H, 2, 2);
      }
      ctx.globalAlpha = 1;
    }

    // walking human
    dude.x += dude.v * dt * dude.dir;
    if(dude.x > 0.92){ dude.x = 0.92; dude.dir = -1; }
    if(dude.x < 0.08){ dude.x = 0.08; dude.dir = 1; }

    var scale = 5.5;
    var pxX = dude.x*W;
    var pxY = dude.y*H + Math.sin(t*6.0)*3;

    ctx.save();
    ctx.translate(pxX, pxY);
    ctx.scale(dude.dir, 1);

    // shadow
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.ellipse(0, 62, 40, 10, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    drawHuman(-16*scale/2, -24*scale, scale, t*12, dude.dir);
    ctx.restore();
  }

  var last = performance.now();
  function loop(now){
    var dt = Math.min(0.033, (now-last)/1000);
    last = now;
    var rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width, rect.height);
    draw(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>

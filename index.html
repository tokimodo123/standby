<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Standby</title>
  <style>
    :root{
      --bg:#0a0f16;
      --fg:#e7eef7;
      --muted: rgba(231,238,247,.65);
      --panel: rgba(255,255,255,.07);
      --panel2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.12);
      --shadow: rgba(0,0,0,.28);
      --accent:#ff5473;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --fg:#0b1220;
      --muted: rgba(11,18,32,.58);
      --panel: rgba(0,0,0,.05);
      --panel2: rgba(0,0,0,.08);
      --border: rgba(0,0,0,.12);
      --shadow: rgba(0,0,0,.08);
      --accent:#ff2f5a;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Hiragino Sans", "Noto Sans JP", sans-serif;}
    body{overflow:hidden;}

    .wrap{
      position:fixed; inset:0;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      box-sizing:border-box;
    }
    .panel{
      border-radius: 24px;
      background: var(--panel);
      border: 1px solid var(--border);
      overflow:hidden;
      position:relative;
    }

    /* LEFT */
    .leftInner{
      height:100%;
      padding:18px;
      box-sizing:border-box;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:14px;
    }
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .digital{
      font-variant-numeric: tabular-nums;
      letter-spacing: .02em;
      line-height:1;
    }
    .digital .time{
      font-size: 112px;
      font-weight: 900;
    }
    .digital .date{
      margin-top:10px;
      font-size: 18px;
      color: var(--muted);
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--fg);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 10px 22px var(--shadow);
    }
    .btn:active{transform: translateY(1px);}

    .midRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .card{
      border-radius: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding:14px;
      box-sizing:border-box;
      min-height: 180px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      letter-spacing: .06em;
    }
    .analogWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      height: calc(100% - 22px);
    }

    .clockSvg{
      width: min(280px, 22vw);
      height: auto;
      filter: drop-shadow(0 10px 22px var(--shadow));
    }
    .dial{
      fill: transparent;
      stroke: var(--border);
      stroke-width: 2;
    }
    .face{
      fill: rgba(0,0,0,.22);
    }
    html[data-theme="light"] .face{ fill: rgba(255,255,255,.50); }

    .tick{stroke: rgba(255,255,255,.35); stroke-width: 2;}
    .tickBig{stroke: rgba(255,255,255,.55); stroke-width: 3;}
    html[data-theme="light"] .tick{stroke: rgba(0,0,0,.30);}
    html[data-theme="light"] .tickBig{stroke: rgba(0,0,0,.45);}

    /* Èáù„ÇíÁ¥∞„Åè */
    .handH{stroke: var(--fg); stroke-width: 5; stroke-linecap: round;}
    .handM{stroke: var(--fg); stroke-width: 4; stroke-linecap: round; opacity:.95;}
    .handS{stroke: var(--accent); stroke-width: 2; stroke-linecap: round; opacity:.95;}
    .pin{fill: var(--fg); opacity:.9;}

    .wxMain{display:flex; align-items:center; gap:12px;}
    .wxIcon{font-size:34px; width:40px; text-align:center;}
    .wxTemp{font-size:30px; font-weight:900; line-height:1;}
    .wxPlace{margin-top:6px; font-size:14px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .wxDetail{margin-top:6px; font-size:12px; color:var(--muted);}
    .wxMeta{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.55;}

    /* RIGHT */
    #scene{position:absolute; inset:0; width:100%; height:100%;}
    .rightBtns{
      position:absolute;
      right:14px;
      bottom:14px;
      display:flex;
      gap:10px;
      z-index:5;
    }

    @media (max-width: 980px){
      .digital .time{font-size: 86px;}
      .midRow{grid-template-columns: 1fr;}
      .clockSvg{width:min(300px, 44vw);}
      .controls{flex-direction:row;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- LEFT -->
    <section class="panel">
      <div class="leftInner">
        <div class="topRow">
          <div class="digital">
            <div class="time" id="time">--:--</div>
            <div class="date" id="date">----</div>
          </div>
          <div class="controls">
            <button class="btn" id="themeBtn">„Éõ„ÉØ„Ç§„Éà</button>
            <button class="btn" id="chatBtn">ChatGPT</button>
          </div>
        </div>

        <div class="midRow">
          <div class="card">
            <div class="label">ANALOG</div>
            <div class="analogWrap">
              <svg class="clockSvg" viewBox="0 0 200 200" aria-label="analog clock">
                <circle cx="100" cy="100" r="90" class="face"></circle>
                <circle cx="100" cy="100" r="92" class="dial"></circle>
                <g id="ticks"></g>
                <g transform="translate(100 100)">
                  <line id="handH" x1="0" y1="10" x2="0" y2="-42" class="handH"></line>
                  <line id="handM" x1="0" y1="14" x2="0" y2="-62" class="handM"></line>
                  <line id="handS" x1="0" y1="18" x2="0" y2="-70" class="handS"></line>
                  <circle r="6" class="pin"></circle>
                </g>
              </svg>
            </div>
          </div>

          <div class="card">
            <div class="label">WEATHER</div>
            <div class="wxMain">
              <div class="wxIcon" id="wxIcon">‚õÖÔ∏è</div>
              <div>
                <div class="wxTemp" id="wxTemp">--¬∞C</div>
                <div class="wxPlace" id="wxPlace">Â§©Ê∞óÂèñÂæóÂæÖ„Å°</div>
                <div class="wxDetail" id="wxDetail">‚Äî</div>
              </div>
            </div>
            <div class="wxMeta" id="wxMeta">‚Äî</div>
          </div>
        </div>

        <div style="flex:1"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <canvas id="scene"></canvas>
      <div class="rightBtns">
        <button class="btn" id="wxBtn">Â§©Ê∞óÊõ¥Êñ∞</button>
      </div>
    </section>
  </div>

<script>
(function(){
  // ====== Safe storage ======
  function storageGet(key){ try { return localStorage.getItem(key); } catch(e){ return null; } }
  function storageSet(key, val){ try { localStorage.setItem(key, val); } catch(e){} }

  // ====== Theme ======
  var themeKey = "standby_theme_v4";
  var root = document.documentElement;
  function applyTheme(t){
    root.setAttribute("data-theme", t);
    storageSet(themeKey, t);
    document.getElementById("themeBtn").textContent = (t === "light") ? "„ÉÄ„Éº„ÇØ" : "„Éõ„ÉØ„Ç§„Éà";
  }
  var saved = storageGet(themeKey);
  if(saved) applyTheme(saved);
  else {
    var prefersLight = false;
    try { prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches; } catch(e){}
    applyTheme(prefersLight ? "light" : "dark");
  }
  document.getElementById("themeBtn").addEventListener("click", function(){
    var cur = root.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  // ====== Chat ======
  document.getElementById("chatBtn").addEventListener("click", function(){
    window.open("https://chatgpt.com", "_blank");
  });

  // ====== Digital + Analog clock ======
  var timeEl = document.getElementById("time");
  var dateEl = document.getElementById("date");
  var handH = document.getElementById("handH");
  var handM = document.getElementById("handM");
  var handS = document.getElementById("handS");
  var sceneHour = 12, sceneMin = 0, sceneSec = 0;

  function pad(n){ return (n<10 ? "0" : "") + n; }
  var dow = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];

  function rot(el, deg){ el.setAttribute("transform", "rotate(" + deg + ")"); }

  // ticks create once
  (function(){
    var ticksG = document.getElementById("ticks");
    var s = "";
    for(var i=0;i<60;i++){
      var a = (Math.PI*2) * (i/60);
      var r1 = 80;
      var r2 = (i%5===0) ? 70 : 74;
      var x1 = 100 + Math.sin(a)*r1;
      var y1 = 100 - Math.cos(a)*r1;
      var x2 = 100 + Math.sin(a)*r2;
      var y2 = 100 - Math.cos(a)*r2;
      var cls = (i%5===0) ? "tickBig" : "tick";
      s += '<line x1="'+x1.toFixed(2)+'" y1="'+y1.toFixed(2)+'" x2="'+x2.toFixed(2)+'" y2="'+y2.toFixed(2)+'" class="'+cls+'" />';
    }
    ticksG.innerHTML = s;
  })();

  function updateAnalog(d){
    var h = d.getHours() % 12;
    var m = d.getMinutes();
    var s = d.getSeconds();
    var ms = d.getMilliseconds();

    var sec = s + ms/1000;
    var min = m + sec/60;
    var hour = h + min/60;

    rot(handS, sec*6);
    rot(handM, min*6);
    rot(handH, hour*30);
  }

  function tick(){
    var d = new Date();
    timeEl.textContent = pad(d.getHours()) + ":" + pad(d.getMinutes());
    dateEl.textContent = d.getFullYear()+"/"+pad(d.getMonth()+1)+"/"+pad(d.getDate())+" ("+dow[d.getDay()]+")";
    updateAnalog(d);
    sceneHour = d.getHours();
    sceneMin = d.getMinutes();
    sceneSec = d.getSeconds();
  }
  tick();
  setInterval(tick, 1000);

  // ====== Weather ======
  var wxIconEl = document.getElementById("wxIcon");
  var wxTempEl = document.getElementById("wxTemp");
  var wxPlaceEl = document.getElementById("wxPlace");
  var wxDetailEl = document.getElementById("wxDetail");
  var wxMetaEl = document.getElementById("wxMeta");

  var currentWxCode = null;
  var currentWxWind = 0;

  function weatherEmoji(code){
    if(code===0) return "‚òÄÔ∏è";
    if(code===1||code===2) return "üå§Ô∏è";
    if(code===3) return "‚òÅÔ∏è";
    if(code===45||code===48) return "üå´Ô∏è";
    if(code===51||code===53||code===55||code===56||code===57) return "üå¶Ô∏è";
    if(code===61||code===63||code===65||code===66||code===67) return "üåßÔ∏è";
    if(code===71||code===73||code===75||code===77) return "üå®Ô∏è";
    if(code===80||code===81||code===82) return "üåßÔ∏è";
    if(code===85||code===86) return "üå®Ô∏è";
    if(code===95||code===96||code===99) return "‚õàÔ∏è";
    return "‚õÖÔ∏è";
  }
  function codeText(code){
    var map = {
      0:"Âø´Êô¥",1:"Êô¥„Çå",2:"Êô¥„ÇåÊôÇ„ÄÖÊõá„Çä",3:"Êõá„Çä",45:"Èúß",48:"Èúß",
      51:"ÈúßÈõ®(Âº±)",53:"ÈúßÈõ®(‰∏≠)",55:"ÈúßÈõ®(Âº∑)",56:"ÂáçÁµêÈúßÈõ®(Âº±)",57:"ÂáçÁµêÈúßÈõ®(Âº∑)",
      61:"Èõ®(Âº±)",63:"Èõ®(‰∏≠)",65:"Èõ®(Âº∑)",66:"ÂáçÁµêÈõ®(Âº±)",67:"ÂáçÁµêÈõ®(Âº∑)",
      71:"Èõ™(Âº±)",73:"Èõ™(‰∏≠)",75:"Èõ™(Âº∑)",77:"Èú∞(„ÅÇ„Çâ„Çå)",
      80:"„Å´„Çè„ÅãÈõ®(Âº±)",81:"„Å´„Çè„ÅãÈõ®(‰∏≠)",82:"„Å´„Çè„ÅãÈõ®(Âº∑)",
      85:"„Å´„Çè„ÅãÈõ™(Âº±)",86:"„Å´„Çè„ÅãÈõ™(Âº∑)",
      95:"Èõ∑Èõ®",96:"Èõ∑Èõ®(Èõπ)",99:"Èõ∑Èõ®(Èõπ)"
    };
    return map[code] || ("Â§©Ê∞ó„Ç≥„Éº„Éâ " + code);
  }

  function setWx(state){
    wxTempEl.textContent = state.tempText || "--¬∞C";
    wxPlaceEl.textContent = state.place || "‚Äî";
    wxDetailEl.textContent = state.detail || "‚Äî";
    wxMetaEl.textContent = state.meta || "‚Äî";
    wxIconEl.textContent = state.icon || "‚õÖÔ∏è";
    if(typeof state.code === "number") currentWxCode = state.code;
    if(typeof state.wind === "number") currentWxWind = state.wind;
  }

  function fetchWithTimeout(url, ms){
    return new Promise(function(resolve, reject){
      var done = false;
      var timer = setTimeout(function(){
        if(done) return;
        done = true;
        reject(new Error("timeout"));
      }, ms);

      fetch(url, {cache:"no-store"})
        .then(function(r){
          if(!r.ok) throw new Error("http");
          return r.json();
        })
        .then(function(j){
          if(done) return;
          done = true;
          clearTimeout(timer);
          resolve(j);
        })
        .catch(function(e){
          if(done) return;
          done = true;
          clearTimeout(timer);
          reject(e);
        });
    });
  }

  function fmtHHMM(iso){
    // "2025-12-26T06:45" -> "06:45"
    if(!iso) return "‚Äî";
    var t = iso.split("T")[1] || "";
    return t.slice(0,5) || "‚Äî";
  }

  function updateWeatherWithCoords(lat, lon, placeText){
    var url =
      "https://api.open-meteo.com/v1/forecast?latitude="+lat+
      "&longitude="+lon+
      "&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m"+
      "&daily=sunrise,sunset"+
      "&forecast_days=1"+
      "&timezone=Asia%2FTokyo";

    return fetchWithTimeout(url, 9000).then(function(wx){
      var cur = wx && wx.current ? wx.current : null;
      if(!cur) throw new Error("baddata");

      var temp = Math.round(cur.temperature_2m);
      var feels= (typeof cur.apparent_temperature === "number") ? Math.round(cur.apparent_temperature) : null;
      var hum  = (typeof cur.relative_humidity_2m === "number") ? Math.round(cur.relative_humidity_2m) : null;

      var code = cur.weather_code;
      var wind = Math.round(cur.wind_speed_10m);

      var sunrise = (wx.daily && wx.daily.sunrise && wx.daily.sunrise[0]) ? fmtHHMM(wx.daily.sunrise[0]) : "‚Äî";
      var sunset  = (wx.daily && wx.daily.sunset  && wx.daily.sunset[0])  ? fmtHHMM(wx.daily.sunset[0])  : "‚Äî";

      setWx({
        tempText: temp + "¬∞C",
        place: placeText,
        detail: codeText(code) + " / È¢® " + wind + "m/s",
        meta:
          "Êó•„ÅÆÂá∫ " + sunrise + " / Êó•„ÅÆÂÖ• " + sunset + "\n" +
          (feels!==null ? ("‰ΩìÊÑü " + feels + "¬∞C") : "‰ΩìÊÑü ‚Äî") + " / " +
          (hum!==null ? ("ÊπøÂ∫¶ " + hum + "%") : "ÊπøÂ∫¶ ‚Äî") + "\n" +
          "ÊúÄÁµÇÊõ¥Êñ∞: " + new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),
        icon: weatherEmoji(code),
        code: code,
        wind: wind
      });
    });
  }

  function reverseGeocode(lat, lon){
    var url = "https://geocoding-api.open-meteo.com/v1/reverse?latitude="+lat+"&longitude="+lon+"&language=ja";
    return fetchWithTimeout(url, 9000).then(function(j){
      var p = j && j.results && j.results[0] ? j.results[0] : null;
      if(!p) return null;
      var parts = [];
      if(p.name) parts.push(p.name);
      if(p.admin1) parts.push(p.admin1);
      if(p.country) parts.push(p.country);
      return parts.join(", ");
    }).catch(function(){ return null; });
  }

  function fallbackTokyo(reason){
    return updateWeatherWithCoords(35.681236, 139.767125, "Êù±‰∫¨Ôºà" + reason + "Ôºâ");
  }

  function updateWeather(){
    setWx({ place:"Â§©Ê∞óÂèñÂæó‰∏≠‚Ä¶", meta:"‚Äî", icon:"‚õÖÔ∏è" });

    var hardTimeout = setTimeout(function(){
      fallbackTokyo("ÂèñÂæó„ÅåÈï∑Âºï„ÅÑ„Åü„Åü„ÇÅÊù±‰∫¨„ÇíË°®Á§∫");
    }, 12000);

    function finish(){ clearTimeout(hardTimeout); }

    if(!navigator.geolocation){
      fallbackTokyo("‰ΩçÁΩÆÊÉÖÂ†±ÈùûÂØæÂøú").then(finish).catch(finish);
      return;
    }

    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;

      reverseGeocode(lat, lon).then(function(place){
        // „Åì„Åì„Åå„Éù„Ç§„É≥„ÉàÔºöËã±Ë™û lat/lon „ÇíÊó•Êú¨Ë™û„Å´
        var label = place || ("Á∑ØÂ∫¶ " + lat.toFixed(2) + " / ÁµåÂ∫¶ " + lon.toFixed(2));
        return updateWeatherWithCoords(lat, lon, label);
      }).then(finish).catch(function(){
        fallbackTokyo("Â§©Ê∞óAPIÂ§±Êïó").then(finish).catch(finish);
      });

    }, function(err){
      var reason = (err && err.code === 1) ? "‰ΩçÁΩÆÊÉÖÂ†±ÊãíÂê¶" : "‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº";
      fallbackTokyo(reason).then(finish).catch(finish);
    }, { enableHighAccuracy:false, timeout:8000, maximumAge: 10*60*1000 });
  }

  document.getElementById("wxBtn").addEventListener("click", updateWeather);
  updateWeather();
  setInterval(updateWeather, 10*60*1000);

  // ====== Right Scene (cute pixel girl + cat + window fish, time-based sky) ======
  var canvas = document.getElementById("scene");
  var ctx = canvas.getContext("2d", {alpha:true});

  function resize(){
    var r = window.devicePixelRatio || 1;
    var rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * r);
    canvas.height= Math.floor(rect.height* r);
    ctx.setTransform(r,0,0,r,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function lerp(a,b,t){ return a+(b-a)*t; }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function skyParams(h){
    var nightTop=[18,16,34], nightBot=[12,10,22];
    var mornTop=[110,175,255], mornBot=[210,235,255];
    var dayTop =[80,170,255], dayBot =[200,240,255];
    var setTop =[235,110,140], setBot=[65,40,90];

    function mix(c1,c2,k){
      return [lerp(c1[0],c2[0],k), lerp(c1[1],c2[1],k), lerp(c1[2],c2[2],k)];
    }

    var top, bot, nightness;
    if(h<5){ top=nightTop; bot=nightBot; nightness=1; }
    else if(h<9){
      var k=(h-5)/4;
      top=mix(nightTop,mornTop,k);
      bot=mix(nightBot,mornBot,k);
      nightness=1-k;
    }else if(h<16){
      var k2=(h-9)/7;
      top=mix(mornTop,dayTop,k2);
      bot=mix(mornBot,dayBot,k2);
      nightness=0;
    }else if(h<19){
      var k3=(h-16)/3;
      top=mix(dayTop,setTop,k3);
      bot=mix(dayBot,setBot,k3);
      nightness=k3*0.55;
    }else{
      var k4=(h-19)/5;
      top=mix(setTop,nightTop,clamp(k4,0,1));
      bot=mix(setBot,nightBot,clamp(k4,0,1));
      nightness=0.55+0.45*clamp(k4,0,1);
    }
    return {top:top, bot:bot, nightness:nightness};
  }

  function bodyPos(p){
    var x = lerp(0.12, 0.88, p);
    var y = 0.62 - Math.sin(p*Math.PI)*0.42;
    return {x:x,y:y};
  }

  // tiny stars (for window only)
  var stars = [];
  for(var i=0;i<120;i++){
    stars.push({x:((i*97)%1000)/1000, y:((i*173)%1000)/1000, s:((i*37)%7)+1});
  }

  // fish
  var fish = [
    {x:0.15,y:0.28,v:0.030, c:"#ff6aa8"},
    {x:0.65,y:0.24,v:0.022, c:"#a98bff"},
    {x:0.42,y:0.33,v:0.018, c:"#ffb86b"}
  ];

  // pixel draw helper
  function drawSprite(grid, x, y, scale, map){
    for(var iy=0; iy<grid.length; iy++){
      var row = grid[iy];
      for(var ix=0; ix<row.length; ix++){
        var ch = row.charAt(ix);
        if(ch === ".") continue;
        var col = map[ch];
        if(!col) continue;
        ctx.fillStyle = col;
        ctx.fillRect(x + ix*scale, y + iy*scale, scale, scale);
      }
    }
  }

  // Cute girl+cat scene (original pixel art)
  // „Åæ„Å∞„Åü„Åç/Áå´„Åó„Å£„ÅΩ/„Éö„Éº„Ç∏„ÇÅ„Åè„ÇäÔºöframe„ÅßÂàáÊõø
  function drawGirlScene(W,H,tt){
    var isLight = (root.getAttribute("data-theme")==="light");
    var accent = isLight ? "rgba(0,0,0,.18)" : "rgba(0,0,0,.28)";

    // room base
    ctx.fillStyle = isLight ? "rgba(255,255,255,.06)" : "rgba(0,0,0,.14)";
    ctx.fillRect(0,0,W,H);

    // desk
    ctx.fillStyle = isLight ? "rgba(0,0,0,.18)" : "rgba(0,0,0,.35)";
    ctx.fillRect(0, H*0.78, W, H*0.22);

    // window (shows time-based sky)
    var winX = W*0.58, winY = H*0.12, winW = W*0.30, winH = H*0.36;
    ctx.fillStyle = isLight ? "rgba(0,0,0,.16)" : "rgba(255,255,255,.08)";
    ctx.fillRect(winX-8, winY-8, winW+16, winH+16);

    // sky in window
    var hourFloat = sceneHour + sceneMin/60 + sceneSec/3600;
    var sp = skyParams(hourFloat);
    var g = ctx.createLinearGradient(0,winY,0,winY+winH);
    g.addColorStop(0, "rgb("+(sp.top[0]|0)+","+(sp.top[1]|0)+","+(sp.top[2]|0)+")");
    g.addColorStop(1, "rgb("+(sp.bot[0]|0)+","+(sp.bot[1]|0)+","+(sp.bot[2]|0)+")");
    ctx.fillStyle = g;
    ctx.fillRect(winX, winY, winW, winH);

    // stars in window at night
    if(sp.nightness > 0.2){
      var base = clamp((sp.nightness-0.15)/0.9, 0, 1);
      for(var i=0;i<stars.length;i++){
        var st = stars[i];
        var tw = 0.35 + 0.65*(0.5+0.5*Math.sin(tt*1.2 + st.s));
        ctx.globalAlpha = base * 0.65 * tw;
        ctx.fillStyle = "white";
        ctx.fillRect(winX + st.x*winW, winY + st.y*winH, 2, 2);
      }
      ctx.globalAlpha = 1;
    }

    // sun/moon in window
    var sunActive = (hourFloat >= 6 && hourFloat < 18);
    var progSun = clamp((hourFloat - 6)/12, 0, 1);
    var progMoon = clamp(((hourFloat >= 18 ? hourFloat : hourFloat+24) - 18)/12, 0, 1);

    if(sunActive){
      var pS = bodyPos(progSun);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = isLight ? "rgba(255,210,120,.95)" : "rgba(255,214,140,.95)";
      ctx.beginPath(); ctx.arc(winX + pS.x*winW, winY + pS.y*winH, 14, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.22;
      ctx.beginPath(); ctx.arc(winX + pS.x*winW, winY + pS.y*winH, 36, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }else{
      var pM = bodyPos(progMoon);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = isLight ? "rgba(255,255,255,.92)" : "rgba(230,240,255,.90)";
      ctx.beginPath(); ctx.arc(winX + pM.x*winW, winY + pM.y*winH, 12, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.beginPath(); ctx.arc(winX + pM.x*winW+4, winY + pM.y*winH-3, 3, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    // fish swim in window
    for(var f=0; f<fish.length; f++){
      var fi = fish[f];
      fi.x += fi.v * (1/60);
      if(fi.x > 1.15) fi.x = -0.15;
      var fx = winX + fi.x*winW;
      var fy = winY + fi.y*winH + Math.sin(tt*1.2 + f)*6;

      ctx.fillStyle = fi.c;
      ctx.globalAlpha = 0.9;
      ctx.fillRect(fx, fy, 10, 4);
      ctx.fillRect(fx+10, fy+1, 2, 2);
      ctx.fillRect(fx-2, fy+1, 2, 2);
      ctx.globalAlpha = 1;
    }

    // curtains
    ctx.fillStyle = isLight ? "rgba(0,0,0,.12)" : "rgba(0,0,0,.22)";
    ctx.fillRect(winX-18, winY-8, 10, winH+16);
    ctx.fillRect(winX+winW+8, winY-8, 10, winH+16);

    // Girl + cat (pixel art)
    var scale = Math.min(W,H) / 140; // auto
    scale = Math.max(4.8, Math.min(7.2, scale));

    var bob = Math.sin(tt*1.2)*2;
    var blink = (Math.sin(tt*0.9) > 0.985);       // eyes closed sometimes
    var page  = (Math.sin(tt*0.6) > 0.60);        // page flip
    var tail  = (Math.sin(tt*1.6) > 0);           // cat tail wag

    // palette (blue-ish like reference vibe)
    var P = {
      ".": null,
      "a": isLight ? "#d7f1ff" : "#bfe7ff",   // light highlight
      "b": isLight ? "#9fd7ff" : "#87cfff",   // mid blue
      "c": isLight ? "#4c86b8" : "#3c6ea0",   // dark blue
      "d": isLight ? "#20324a" : "#18283e",   // deep
      "s": isLight ? "#f2c9a0" : "#e7b98d",   // skin
      "h": isLight ? "#2a2a2a" : "#141414",   // hair
      "p": isLight ? "#ff6aa8" : "#ff6aa8",   // pink accent
      "k": isLight ? "#2b2b2b" : "#111111",   // cat outline
      "w": isLight ? "#ffffff" : "#e7eef7"    // white
    };

    // Girl sprite 28x28 sitting + book
    var girlOpen = [
      "............hhhhhhhh............",
      "...........hhhhhhhhhh...........",
      "..........hhhhhhhhh..h..........",
      ".........hhh..hhhh....h.........",
      "........hh....hhhh.....h........",
      "........hh....hhhh.....h........",
      "........hh....hhhh.....h........",
      ".........hhh..hhhh....h.........",
      "..........hhhhhhhhhhhhh.........",
      "...........hhhhhhhhhhh..........",
      ".............ssssss.............",
      "............sssss.s.............",
      "...........ssssssss.............",
      "...........ss..ss..s............",
      "...........ss..ss..s............",
      "............ssssssss............",
      ".............bbbbbb.............",
      "............bbbbbbbb............",
      "...........bbbbbbbbbb...........",
      "..........bbbbb..bbbbb..........",
      ".........bbbb......bbbb.........",
      "........bbbb..wwww..bbbb........",
      ".......bbbb..wwwwww..bbbb.......",
      "......bbbb...wwwwww...bbbb......",
      ".....bbbb....wwwwww....bbbb.....",
      "....bbbb.....wwwwww.....bbbb....",
      "....bbbb......wwww......bbbb....",
      ".....dd........dd........dd....."
    ];

    // blink version (eyes line)
    var girlBlink = girlOpen.slice();
    // we'll just overlay eye line later; keep simple

    // Book page change (slight difference)
    var book2 = page ? "......bbbb...wwwwww...bbbb......" : "......bbbb...wwwwww...bbbb......";

    // Cat sprite 18x14
    var catBase = [
      "..kkkkkkkkkkkkkk..",
      ".kkk...........kkk.",
      "kkk.............kkk",
      "kk...w.....w.....kk",
      "kk...............kk",
      "kk......k........kk",
      "kk...............kk",
      ".kkk...........kkk.",
      "..kkkkkkkkkkkkkk..",
      ".....kkk....kkk....",
      ".....kk......kk....",
      ".....kk......kk....",
      ".....kk......kk....",
      ".....dd......dd...."
    ];

    // cat tail (2 frames)
    var tailOn = tail ? [
      "........kk....",
      ".......kk.....",
      "......kk......"
    ] : [
      "......kk......",
      ".......kk.....",
      "........kk...."
    ];

    // draw girl (convert chars to palette)
    // We'll interpret: h=hair, s=skin, b=clothes, w=book, d=shadow base
    // Map letters
    function mapRow(row){
      return row.replace(/h/g,"h").replace(/s/g,"s").replace(/b/g,"b").replace(/w/g,"w").replace(/d/g,"d");
    }
    var gx = W*0.18, gy = H*0.30 + bob;
    // build mapped grid with palette keys
    var grid = girlOpen.map(mapRow);

    // draw grid manually with palette:
    for(var iy=0; iy<grid.length; iy++){
      var row = grid[iy];
      for(var ix=0; ix<row.length; ix++){
        var ch = row.charAt(ix);
        if(ch===".") continue;
        var col = P[ch];
        if(!col) continue;
        ctx.fillStyle = col;
        ctx.fillRect(gx + ix*scale, gy + iy*scale, scale, scale);
      }
    }

    // eyes: blink or open
    ctx.fillStyle = "#0b0b0b";
    if(blink){
      // line eyes
      ctx.fillRect(gx + 13*scale, gy + 12*scale, 3*scale, 1*scale);
      ctx.fillRect(gx + 18*scale, gy + 12*scale, 3*scale, 1*scale);
    }else{
      ctx.fillRect(gx + 14*scale, gy + 12*scale, 1*scale, 1*scale);
      ctx.fillRect(gx + 20*scale, gy + 12*scale, 1*scale, 1*scale);
    }
    // small blush
    ctx.fillStyle = "rgba(255,106,168,.55)";
    ctx.fillRect(gx + 12*scale, gy + 14*scale, 1*scale, 1*scale);
    ctx.fillRect(gx + 22*scale, gy + 14*scale, 1*scale, 1*scale);

    // cat
    var cx = W*0.42, cy = H*0.66 + bob*0.5;
    // map cat: k outline, w face
    var catMap = Object.assign({}, P, { "k": P.k, "w": P.w, "d": P.d });
    drawSprite(catBase, cx, cy, scale, catMap);

    // tail overlay (to the left)
    ctx.fillStyle = P.k;
    for(var ty=0; ty<tailOn.length; ty++){
      for(var tx=0; tx<tailOn[ty].length; tx++){
        if(tailOn[ty].charAt(tx) === "k"){
          ctx.fillRect(cx - (tx+2)*scale, cy + (ty+6)*scale, scale, scale);
        }
      }
    }

    // cup (simple)
    ctx.fillStyle = isLight ? "rgba(255,255,255,.65)" : "rgba(255,255,255,.45)";
    ctx.fillRect(W*0.78, H*0.73, 18, 14);
    ctx.fillRect(W*0.80, H*0.71, 14, 3);
    ctx.globalAlpha = 1;

    // subtle vignette
    ctx.fillStyle = accent;
    ctx.globalAlpha = 0.10;
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 1;
  }

  // ====== Loop ======
  var last = performance.now();
  function loop(now){
    var dt = Math.min(0.033, (now-last)/1000);
    last = now;

    var rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width, rect.height);

    drawGirlScene(rect.width, rect.height, now/1000);

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>

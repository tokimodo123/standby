<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Standby</title>
  <style>
    :root{
      --bg:#0a0f16;
      --fg:#e7eef7;
      --muted: rgba(231,238,247,.65);
      --panel: rgba(255,255,255,.07);
      --panel2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.12);
      --shadow: rgba(0,0,0,.28);
      --accent:#ff5473;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --fg:#0b1220;
      --muted: rgba(11,18,32,.58);
      --panel: rgba(0,0,0,.05);
      --panel2: rgba(0,0,0,.08);
      --border: rgba(0,0,0,.12);
      --shadow: rgba(0,0,0,.08);
      --accent:#ff2f5a;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Hiragino Sans", "Noto Sans JP", sans-serif;}
    body{overflow:hidden;}

    .wrap{
      position:fixed; inset:0;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      box-sizing:border-box;
    }
    .panel{
      border-radius: 24px;
      background: var(--panel);
      border: 1px solid var(--border);
      overflow:hidden;
      position:relative;
    }

    /* LEFT */
    .leftInner{
      height:100%;
      padding:18px;
      box-sizing:border-box;
      display:grid;
      grid-template-rows: auto auto auto 1fr;
      gap:14px;
    }
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .digital{
      font-variant-numeric: tabular-nums;
      letter-spacing: .02em;
      line-height:1;
    }
    .digital .time{
      font-size: 112px;
      font-weight: 900;
    }
    .digital .date{
      margin-top:10px;
      font-size: 18px;
      color: var(--muted);
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--fg);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 10px 22px var(--shadow);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px);}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap;}

    .midRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .card{
      border-radius: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding:14px;
      box-sizing:border-box;
      min-height: 180px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      letter-spacing: .06em;
    }

    /* Analog clock */
    .analogWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      height: calc(100% - 22px);
    }
    .clockSvg{
      width: min(280px, 22vw);
      height: auto;
      filter: drop-shadow(0 10px 22px var(--shadow));
    }
    .dial{fill: transparent; stroke: var(--border); stroke-width: 2;}
    .face{fill: rgba(0,0,0,.20);}
    html[data-theme="light"] .face{ fill: rgba(255,255,255,.55); }
    .tick{stroke: rgba(255,255,255,.35); stroke-width: 2;}
    .tickBig{stroke: rgba(255,255,255,.55); stroke-width: 3;}
    html[data-theme="light"] .tick{stroke: rgba(0,0,0,.30);}
    html[data-theme="light"] .tickBig{stroke: rgba(0,0,0,.45);}
    /* é‡ã‚’ç´°ã */
    .handH{stroke: var(--fg); stroke-width: 5; stroke-linecap: round;}
    .handM{stroke: var(--fg); stroke-width: 4; stroke-linecap: round; opacity:.95;}
    .handS{stroke: var(--accent); stroke-width: 2; stroke-linecap: round; opacity:.95;}
    .pin{fill: var(--fg); opacity:.9;}

    /* Weather */
    .wxMain{display:flex; align-items:center; gap:12px;}
    .wxIcon{font-size:34px; width:40px; text-align:center;}
    .wxTemp{font-size:30px; font-weight:900; line-height:1;}
    .wxPlace{margin-top:6px; font-size:14px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .wxDetail{margin-top:6px; font-size:12px; color:var(--muted);}
    .wxMeta{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.55; white-space:pre-line;}

    /* Stopwatch */
    .swDisplay{
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      letter-spacing: .02em;
      font-size: 46px;
      line-height:1.1;
      margin-top: 6px;
    }
    .swSub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }

    /* RIGHT */
    #scene{position:absolute; inset:0; width:100%; height:100%;}
    .rightOverlay{
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.22));
      opacity: .45;
    }
    .rightBtns{
      position:absolute;
      right:14px;
      bottom:14px;
      display:flex;
      gap:10px;
      z-index:5;
    }

    @media (max-width: 980px){
      .digital .time{font-size: 86px;}
      .midRow{grid-template-columns: 1fr;}
      .clockSvg{width:min(300px, 44vw);}
      .controls{flex-direction:row;}
      .swDisplay{font-size: 38px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- LEFT -->
    <section class="panel">
      <div class="leftInner">
        <div class="topRow">
          <div class="digital">
            <div class="time" id="time">--:--</div>
            <div class="date" id="date">----</div>
          </div>
          <div class="controls">
            <button class="btn" id="themeBtn">ãƒ›ãƒ¯ã‚¤ãƒˆ</button>
            <button class="btn" id="chatBtn">ChatGPT</button>
          </div>
        </div>

        <div class="midRow">
          <div class="card">
            <div class="label">ANALOG</div>
            <div class="analogWrap">
              <svg class="clockSvg" viewBox="0 0 200 200" aria-label="analog clock">
                <circle cx="100" cy="100" r="90" class="face"></circle>
                <circle cx="100" cy="100" r="92" class="dial"></circle>
                <g id="ticks"></g>
                <g transform="translate(100 100)">
                  <line id="handH" x1="0" y1="10" x2="0" y2="-42" class="handH"></line>
                  <line id="handM" x1="0" y1="14" x2="0" y2="-62" class="handM"></line>
                  <line id="handS" x1="0" y1="18" x2="0" y2="-70" class="handS"></line>
                  <circle r="6" class="pin"></circle>
                </g>
              </svg>
            </div>
          </div>

          <div class="card">
            <div class="label">WEATHER</div>
            <div class="wxMain">
              <div class="wxIcon" id="wxIcon">â›…ï¸</div>
              <div>
                <div class="wxTemp" id="wxTemp">--Â°C</div>
                <div class="wxPlace" id="wxPlace">å¤©æ°—å–å¾—å¾…ã¡</div>
                <div class="wxDetail" id="wxDetail">â€”</div>
              </div>
            </div>
            <div class="wxMeta" id="wxMeta">â€”</div>
          </div>
        </div>

        <div class="card">
          <div class="label">STOPWATCH</div>
          <div class="swDisplay" id="swText">00:00.00</div>
          <div class="btnRow" style="margin-top:12px;">
            <button class="btn" id="swStartStop">Start</button>
            <button class="btn" id="swReset">Reset</button>
          </div>
          <div class="swSub" id="swHint">å‹‰å¼·ã®è¨ˆæ¸¬ã«ã©ã†ã</div>
        </div>

        <div style="flex:1"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <canvas id="scene"></canvas>
      <div class="rightOverlay"></div>
      <div class="rightBtns">
        <button class="btn" id="wxBtn">å¤©æ°—æ›´æ–°</button>
      </div>
    </section>
  </div>

<script>
(function(){
  // ---- safe storage ----
  function storageGet(key){ try { return localStorage.getItem(key); } catch(e){ return null; } }
  function storageSet(key, val){ try { localStorage.setItem(key, val); } catch(e){} }

  // ---- theme ----
  var root = document.documentElement;
  var themeKey = "standby_theme_v5";
  function applyTheme(t){
    root.setAttribute("data-theme", t);
    storageSet(themeKey, t);
    document.getElementById("themeBtn").textContent = (t === "light") ? "ãƒ€ãƒ¼ã‚¯" : "ãƒ›ãƒ¯ã‚¤ãƒˆ";
  }
  var saved = storageGet(themeKey);
  if(saved) applyTheme(saved);
  else{
    var prefersLight = false;
    try{ prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches; }catch(e){}
    applyTheme(prefersLight ? "light" : "dark");
  }
  document.getElementById("themeBtn").addEventListener("click", function(){
    var cur = root.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  // ---- chat ----
  document.getElementById("chatBtn").addEventListener("click", function(){
    window.open("https://chatgpt.com", "_blank");
  });

  // ---- clock ----
  var timeEl = document.getElementById("time");
  var dateEl = document.getElementById("date");
  var handH = document.getElementById("handH");
  var handM = document.getElementById("handM");
  var handS = document.getElementById("handS");

  var sceneHour = 12, sceneMin = 0, sceneSec = 0;
  function pad(n){ return (n<10?"0":"")+n; }
  var dow = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  function rot(el, deg){ el.setAttribute("transform", "rotate("+deg+")"); }

  // ticks once
  (function(){
    var ticksG = document.getElementById("ticks");
    var s = "";
    for(var i=0;i<60;i++){
      var a = (Math.PI*2)*(i/60);
      var r1 = 80;
      var r2 = (i%5===0)?70:74;
      var x1 = 100 + Math.sin(a)*r1;
      var y1 = 100 - Math.cos(a)*r1;
      var x2 = 100 + Math.sin(a)*r2;
      var y2 = 100 - Math.cos(a)*r2;
      var cls = (i%5===0) ? "tickBig" : "tick";
      s += '<line x1="'+x1.toFixed(2)+'" y1="'+y1.toFixed(2)+'" x2="'+x2.toFixed(2)+'" y2="'+y2.toFixed(2)+'" class="'+cls+'" />';
    }
    ticksG.innerHTML = s;
  })();

  function updateAnalog(d){
    var h = d.getHours()%12;
    var m = d.getMinutes();
    var s = d.getSeconds();
    var ms = d.getMilliseconds();
    var sec = s + ms/1000;
    var min = m + sec/60;
    var hour = h + min/60;
    rot(handS, sec*6);
    rot(handM, min*6);
    rot(handH, hour*30);
  }

  function tick(){
    var d = new Date();
    timeEl.textContent = pad(d.getHours())+":"+pad(d.getMinutes());
    dateEl.textContent = d.getFullYear()+"/"+pad(d.getMonth()+1)+"/"+pad(d.getDate())+" ("+dow[d.getDay()]+")";
    updateAnalog(d);
    sceneHour = d.getHours();
    sceneMin = d.getMinutes();
    sceneSec = d.getSeconds();
  }
  tick();
  setInterval(tick, 1000);

  // ---- weather ----
  var wxIconEl = document.getElementById("wxIcon");
  var wxTempEl = document.getElementById("wxTemp");
  var wxPlaceEl = document.getElementById("wxPlace");
  var wxDetailEl = document.getElementById("wxDetail");
  var wxMetaEl = document.getElementById("wxMeta");

  // for scene effects
  var currentWxCode = null;
  var currentWxWind = 0;

  function weatherEmoji(code){
    if(code===0) return "â˜€ï¸";
    if(code===1||code===2) return "ğŸŒ¤ï¸";
    if(code===3) return "â˜ï¸";
    if(code===45||code===48) return "ğŸŒ«ï¸";
    if(code===51||code===53||code===55||code===56||code===57) return "ğŸŒ¦ï¸";
    if(code===61||code===63||code===65||code===66||code===67) return "ğŸŒ§ï¸";
    if(code===71||code===73||code===75||code===77) return "ğŸŒ¨ï¸";
    if(code===80||code===81||code===82) return "ğŸŒ§ï¸";
    if(code===85||code===86) return "ğŸŒ¨ï¸";
    if(code===95||code===96||code===99) return "â›ˆï¸";
    return "â›…ï¸";
  }
  function codeText(code){
    var map = {
      0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§",
      51:"éœ§é›¨(å¼±)",53:"éœ§é›¨(ä¸­)",55:"éœ§é›¨(å¼·)",56:"å‡çµéœ§é›¨(å¼±)",57:"å‡çµéœ§é›¨(å¼·)",
      61:"é›¨(å¼±)",63:"é›¨(ä¸­)",65:"é›¨(å¼·)",66:"å‡çµé›¨(å¼±)",67:"å‡çµé›¨(å¼·)",
      71:"é›ª(å¼±)",73:"é›ª(ä¸­)",75:"é›ª(å¼·)",77:"éœ°(ã‚ã‚‰ã‚Œ)",
      80:"ã«ã‚ã‹é›¨(å¼±)",81:"ã«ã‚ã‹é›¨(ä¸­)",82:"ã«ã‚ã‹é›¨(å¼·)",
      85:"ã«ã‚ã‹é›ª(å¼±)",86:"ã«ã‚ã‹é›ª(å¼·)",
      95:"é›·é›¨",96:"é›·é›¨(é›¹)",99:"é›·é›¨(é›¹)"
    };
    return map[code] || ("å¤©æ°—ã‚³ãƒ¼ãƒ‰ " + code);
  }

  function setWx(state){
    wxTempEl.textContent = state.tempText || "--Â°C";
    wxPlaceEl.textContent = state.place || "â€”";
    wxDetailEl.textContent = state.detail || "â€”";
    wxMetaEl.textContent = state.meta || "â€”";
    wxIconEl.textContent = state.icon || "â›…ï¸";
    if(typeof state.code==="number") currentWxCode = state.code;
    if(typeof state.wind==="number") currentWxWind = state.wind;
  }

  function fetchWithTimeout(url, ms){
    return new Promise(function(resolve, reject){
      var done = false;
      var timer = setTimeout(function(){
        if(done) return; done = true; reject(new Error("timeout"));
      }, ms);

      fetch(url, {cache:"no-store"})
        .then(function(r){ if(!r.ok) throw new Error("http"); return r.json(); })
        .then(function(j){ if(done) return; done=true; clearTimeout(timer); resolve(j); })
        .catch(function(e){ if(done) return; done=true; clearTimeout(timer); reject(e); });
    });
  }

  function fmtHHMM(iso){
    if(!iso) return "â€”";
    var t = (iso.split("T")[1] || "");
    return t.slice(0,5) || "â€”";
  }

  function updateWeatherWithCoords(lat, lon, placeText){
    var url =
      "https://api.open-meteo.com/v1/forecast?latitude="+lat+
      "&longitude="+lon+
      "&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m"+
      "&daily=sunrise,sunset"+
      "&forecast_days=1"+
      "&timezone=Asia%2FTokyo";

    return fetchWithTimeout(url, 9000).then(function(wx){
      var cur = wx && wx.current ? wx.current : null;
      if(!cur) throw new Error("baddata");

      var temp = Math.round(cur.temperature_2m);
      var feels= (typeof cur.apparent_temperature === "number") ? Math.round(cur.apparent_temperature) : null;
      var hum  = (typeof cur.relative_humidity_2m === "number") ? Math.round(cur.relative_humidity_2m) : null;

      var code = cur.weather_code;
      var wind = Math.round(cur.wind_speed_10m);

      var sunrise = (wx.daily && wx.daily.sunrise && wx.daily.sunrise[0]) ? fmtHHMM(wx.daily.sunrise[0]) : "â€”";
      var sunset  = (wx.daily && wx.daily.sunset  && wx.daily.sunset[0])  ? fmtHHMM(wx.daily.sunset[0])  : "â€”";

      setWx({
        tempText: temp + "Â°C",
        place: placeText,
        detail: codeText(code) + " / é¢¨ " + wind + "m/s",
        meta:
          "æ—¥ã®å‡º " + sunrise + " / æ—¥ã®å…¥ " + sunset + "\n" +
          (feels!==null ? ("ä½“æ„Ÿ " + feels + "Â°C") : "ä½“æ„Ÿ â€”") + " / " +
          (hum!==null ? ("æ¹¿åº¦ " + hum + "%") : "æ¹¿åº¦ â€”") + "\n" +
          "æœ€çµ‚æ›´æ–°: " + new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),
        icon: weatherEmoji(code),
        code: code,
        wind: wind
      });
    });
  }

  function reverseGeocode(lat, lon){
    var url = "https://geocoding-api.open-meteo.com/v1/reverse?latitude="+lat+"&longitude="+lon+"&language=ja";
    return fetchWithTimeout(url, 9000).then(function(j){
      var p = j && j.results && j.results[0] ? j.results[0] : null;
      if(!p) return null;
      var parts = [];
      if(p.name) parts.push(p.name);
      if(p.admin1) parts.push(p.admin1);
      if(p.country) parts.push(p.country);
      return parts.join(", ");
    }).catch(function(){ return null; });
  }

  function fallbackTokyo(reason){
    return updateWeatherWithCoords(35.681236, 139.767125, "æ±äº¬ï¼ˆ"+reason+"ï¼‰");
  }

  function updateWeather(){
    setWx({ place:"å¤©æ°—å–å¾—ä¸­â€¦", meta:"â€”", icon:"â›…ï¸" });

    var hardTimeout = setTimeout(function(){
      fallbackTokyo("å–å¾—ãŒé•·å¼•ã„ãŸãŸã‚æ±äº¬ã‚’è¡¨ç¤º");
    }, 12000);
    function finish(){ clearTimeout(hardTimeout); }

    if(!navigator.geolocation){
      fallbackTokyo("ä½ç½®æƒ…å ±éå¯¾å¿œ").then(finish).catch(finish);
      return;
    }

    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;

      reverseGeocode(lat, lon).then(function(place){
        var label = place || ("ç·¯åº¦ " + lat.toFixed(2) + " / çµŒåº¦ " + lon.toFixed(2));
        return updateWeatherWithCoords(lat, lon, label);
      }).then(finish).catch(function(){
        fallbackTokyo("å¤©æ°—APIå¤±æ•—").then(finish).catch(finish);
      });
    }, function(err){
      var reason = (err && err.code === 1) ? "ä½ç½®æƒ…å ±æ‹’å¦" : "ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼";
      fallbackTokyo(reason).then(finish).catch(finish);
    }, { enableHighAccuracy:false, timeout:8000, maximumAge: 10*60*1000 });
  }

  document.getElementById("wxBtn").addEventListener("click", updateWeather);
  updateWeather();
  setInterval(updateWeather, 10*60*1000);

  // ---- STOPWATCH ----
  var swText = document.getElementById("swText");
  var swStartStop = document.getElementById("swStartStop");
  var swReset = document.getElementById("swReset");

  var swRunning = false;
  var swBaseMs = 0;          // accumulated
  var swStartAt = 0;         // performance.now at start
  var swRAF = 0;

  function fmtStopwatch(ms){
    ms = Math.max(0, ms|0);
    var totalCs = Math.floor(ms/10); // centiseconds
    var cs = totalCs % 100;
    var totalSec = Math.floor(totalCs/100);
    var sec = totalSec % 60;
    var min = Math.floor(totalSec/60);
    if(min < 100) return pad(min)+":"+pad(sec)+"."+pad(cs);
    // 100åˆ†è¶…ãˆãŸã‚‰ hh:mm:ss
    var hr = Math.floor(min/60);
    min = min % 60;
    return pad(hr)+":"+pad(min)+":"+pad(sec);
  }

  function swNowMs(){
    return swRunning ? (swBaseMs + (performance.now() - swStartAt)) : swBaseMs;
  }

  function swRender(){
    swText.textContent = fmtStopwatch(swNowMs());
    if(swRunning) swRAF = requestAnimationFrame(swRender);
  }

  function swSetButtons(){
    swStartStop.textContent = swRunning ? "Stop" : "Start";
  }

  swStartStop.addEventListener("click", function(){
    if(!swRunning){
      swRunning = true;
      swStartAt = performance.now();
      swSetButtons();
      cancelAnimationFrame(swRAF);
      swRender();
    }else{
      swBaseMs = swNowMs();
      swRunning = false;
      swSetButtons();
      cancelAnimationFrame(swRAF);
      swText.textContent = fmtStopwatch(swBaseMs);
    }
  });

  swReset.addEventListener("click", function(){
    swRunning = false;
    swBaseMs = 0;
    swSetButtons();
    cancelAnimationFrame(swRAF);
    swText.textContent = "00:00.00";
  });

  swSetButtons();
  swText.textContent = "00:00.00";

  // ---- RIGHT CANVAS: emo sky + sun/moon + stars + fishes (+ optional rain/snow) ----
  var canvas = document.getElementById("scene");
  var ctx = canvas.getContext("2d", {alpha:true});

  function resize(){
    var r = window.devicePixelRatio || 1;
    var rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * r);
    canvas.height= Math.floor(rect.height* r);
    ctx.setTransform(r,0,0,r,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function lerp(a,b,t){ return a+(b-a)*t; }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  // sky palette by time: night â†’ dawn orange â†’ day blue â†’ sunset orange â†’ night
  function skyParams(hourFloat){
    var nightTop=[18,16,36], nightBot=[10,10,20];
    var dawnTop =[255,155,120], dawnBot =[110,70,120];
    var dayTop  =[70,170,255], dayBot  =[205,242,255];
    var duskTop =[255,130,140], duskBot=[70,45,110];

    function mix(c1,c2,k){ return [lerp(c1[0],c2[0],k), lerp(c1[1],c2[1],k), lerp(c1[2],c2[2],k)]; }

    var h = hourFloat;
    var top, bot, nightness;

    if(h < 5){
      top = nightTop; bot = nightBot; nightness = 1;
    }else if(h < 8){ // dawn
      var k = (h-5)/3;
      top = mix(nightTop, dawnTop, k);
      bot = mix(nightBot, dawnBot, k);
      nightness = 1-k*0.9;
    }else if(h < 16){ // day
      var k2 = (h-8)/8;
      top = mix(dawnTop, dayTop, k2);
      bot = mix(dawnBot, dayBot, k2);
      nightness = 0;
    }else if(h < 19){ // sunset
      var k3 = (h-16)/3;
      top = mix(dayTop, duskTop, k3);
      bot = mix(dayBot, duskBot, k3);
      nightness = k3*0.55;
    }else{
      var k4 = (h-19)/5;
      top = mix(duskTop, nightTop, clamp(k4,0,1));
      bot = mix(duskBot, nightBot, clamp(k4,0,1));
      nightness = 0.55 + 0.45*clamp(k4,0,1);
    }
    return {top:top, bot:bot, nightness:nightness};
  }

  function arcPos(p){
    // arc across sky
    var x = lerp(0.08, 0.92, p);
    var y = 0.62 - Math.sin(p*Math.PI)*0.42;
    return {x:x, y:y};
  }

  // stars
  var stars = [];
  for(var i=0;i<160;i++){
    stars.push({x:((i*97)%1000)/1000, y:((i*173)%1000)/1000, s:((i*37)%7)+1});
  }

  // fish objects
  function makeFish(){
    var colors = ["rgba(255,106,168,.92)","rgba(152,215,255,.92)","rgba(255,195,120,.92)","rgba(170,140,255,.92)"];
    return {
      x: Math.random()*1.2 - 0.1,
      y: Math.random()*0.55 + 0.20,
      v: 0.03 + Math.random()*0.05,
      s: 0.8 + Math.random()*0.9,
      c: colors[(Math.random()*colors.length)|0],
      dir: (Math.random()<0.5)?1:-1,
      bob: Math.random()*6.28
    };
  }
  var fishes = [];
  for(var f=0; f<10; f++) fishes.push(makeFish());

  // rain/snow particles (optional)
  var drops = [];
  for(var d=0; d<160; d++) drops.push({x:Math.random(), y:Math.random(), v:0.9+Math.random()*1.4, l:0.015+Math.random()*0.02});
  var flakes = [];
  for(var s=0; s<130; s++) flakes.push({x:Math.random(), y:Math.random(), v:0.12+Math.random()*0.25, w:(Math.random()*2-1)*0.10});

  function wxKind(code){
    if(code == null) return "unknown";
    if(code===0||code===1) return "clear";
    if(code===2||code===3) return "cloudy";
    if(code===45||code===48) return "fog";
    if(code===51||code===53||code===55||code===56||code===57) return "drizzle";
    if(code===61||code===63||code===65||code===66||code===67||code===80||code===81||code===82||code===95||code===96||code===99) return "rain";
    if(code===71||code===73||code===75||code===77||code===85||code===86) return "snow";
    return "cloudy";
  }

  function drawFish(px, py, size, dir, color){
    // simple emo fish (pixel-ish)
    ctx.save();
    ctx.translate(px, py);
    ctx.scale(dir, 1);
    ctx.fillStyle = color;

    // body
    ctx.globalAlpha = 0.90;
    ctx.fillRect(-10*size, -3*size, 20*size, 6*size);
    // head bump
    ctx.fillRect(8*size, -2*size, 4*size, 4*size);
    // tail
    ctx.globalAlpha = 0.75;
    ctx.fillRect(-14*size, -2*size, 4*size, 4*size);
    ctx.fillRect(-18*size, -1*size, 4*size, 2*size);
    // eye
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(0,0,0,.45)";
    ctx.fillRect(9*size, -1*size, 1.6*size, 1.6*size);
    ctx.restore();
    ctx.globalAlpha = 1;
  }

  var last = performance.now();
  function loop(now){
    var dt = Math.min(0.033, (now-last)/1000);
    last = now;
    var t = now/1000;

    var rect = canvas.getBoundingClientRect();
    var W = rect.width, H = rect.height;

    // time
    var hourFloat = sceneHour + sceneMin/60 + sceneSec/3600;
    var sp = skyParams(hourFloat);

    // background gradient
    var g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgb("+(sp.top[0]|0)+","+(sp.top[1]|0)+","+(sp.top[2]|0)+")");
    g.addColorStop(1, "rgb("+(sp.bot[0]|0)+","+(sp.bot[1]|0)+","+(sp.bot[2]|0)+")");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // stars at night
    if(sp.nightness > 0.15){
      var base = clamp((sp.nightness-0.1)/0.9, 0, 1);
      for(var i=0;i<stars.length;i++){
        var st = stars[i];
        var tw = 0.35 + 0.65*(0.5+0.5*Math.sin(t*1.2 + st.s));
        ctx.globalAlpha = base * 0.65 * tw;
        ctx.fillStyle = "white";
        ctx.fillRect(st.x*W, st.y*H*0.70, 2, 2);
      }
      ctx.globalAlpha = 1;
    }

    // sun/moon
    var sunActive = (hourFloat >= 6 && hourFloat < 18);
    var progSun = clamp((hourFloat - 6)/12, 0, 1);
    var progMoon = clamp(((hourFloat >= 18 ? hourFloat : hourFloat+24) - 18)/12, 0, 1);

    if(sunActive){
      var pS = arcPos(progSun);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = "rgba(255,214,140,.95)";
      ctx.beginPath(); ctx.arc(pS.x*W, pS.y*H, 22, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.20;
      ctx.beginPath(); ctx.arc(pS.x*W, pS.y*H, 60, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }else{
      var pM = arcPos(progMoon);
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = "rgba(235,245,255,.92)";
      ctx.beginPath(); ctx.arc(pM.x*W, pM.y*H, 18, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.16;
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.beginPath(); ctx.arc(pM.x*W+6, pM.y*H-4, 4, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    // subtle fog / vignette
    ctx.globalAlpha = 0.10;
    ctx.fillStyle = "black";
    ctx.fillRect(0, H*0.70, W, H*0.30);
    ctx.globalAlpha = 1;

    // fishes (emotive, drifting)
    for(var j=0; j<fishes.length; j++){
      var fi = fishes[j];
      fi.x += fi.v * dt * fi.dir;
      fi.bob += dt * (0.8 + fi.s*0.3);

      // wrap
      if(fi.dir===1 && fi.x > 1.25) { fi.x = -0.25; fi.y = Math.random()*0.55 + 0.20; }
      if(fi.dir===-1 && fi.x < -0.25){ fi.x = 1.25; fi.y = Math.random()*0.55 + 0.20; }

      var px = fi.x * W;
      var py = fi.y * H + Math.sin(fi.bob + j)*10;
      var size = 1.8 * fi.s;

      // depth alpha
      ctx.globalAlpha = 0.85 - fi.y*0.25;
      drawFish(px, py, size, fi.dir, fi.c);
      ctx.globalAlpha = 1;
    }

    // weather effect (optional)
    var kind = wxKind(currentWxCode);
    if(kind==="rain" || kind==="drizzle"){
      ctx.globalAlpha = 0.28;
      ctx.strokeStyle = (root.getAttribute("data-theme")==="light") ? "rgba(0,0,0,.22)" : "rgba(255,255,255,.18)";
      ctx.lineWidth = 2;
      for(var k=0;k<drops.length;k++){
        var dr = drops[k];
        dr.y += dr.v * dt * 0.9;
        dr.x += 0.06 * dt * (1 + (currentWxWind? currentWxWind/18 : 0));
        if(dr.y > 1){ dr.y = -Math.random()*0.2; dr.x = Math.random(); }
        if(dr.x > 1.1) dr.x = -0.1;
        var x = dr.x*W, y = dr.y*H;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+10, y+H*dr.l);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
    }
    if(kind==="snow"){
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = (root.getAttribute("data-theme")==="light") ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.80)";
      for(var q=0;q<flakes.length;q++){
        var fl = flakes[q];
        fl.y += fl.v * dt;
        fl.x += (fl.w * dt) + 0.02*Math.sin(t*0.6 + fl.y*10)*dt;
        if(fl.y > 1){ fl.y = -Math.random()*0.2; fl.x = Math.random(); }
        if(fl.x > 1.1) fl.x = -0.1;
        ctx.fillRect(fl.x*W, fl.y*H, 2, 2);
      }
      ctx.globalAlpha = 1;
    }

    requestAnimationFrame(loop);
  }

  // initial clear
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>

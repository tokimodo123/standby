<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Standby</title>
  <style>
    :root{
      --bg:#070b10;
      --fg:#e6edf3;
      --muted: rgba(230,237,243,.68);
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Hiragino Sans", "Noto Sans JP", sans-serif;}
    body{overflow:hidden;}

    .wrap{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows:auto 1fr;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      gap:14px;
    }

    .top{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px;
    }

    .clock{
      font-variant-numeric: tabular-nums;
      letter-spacing: .02em;
      line-height:1;
    }
    .clock .time{
      font-size: 92px;
      font-weight: 800;
    }
    .clock .date{
      margin-top:10px;
      font-size: 18px;
      color: var(--muted);
    }

    .rightPanel{
      display:flex;
      gap:12px;
      align-items:stretch;
    }

    .card{
      padding:12px 14px;
      border-radius: 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      min-width: 260px;
    }
    .card .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .weatherRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .wxMain{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .wxIcon{
      font-size: 28px;
      width: 34px;
      text-align:center;
    }
    .wxText{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .wxPlace{
      font-size: 14px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 220px;
    }
    .wxTemp{
      font-size: 22px;
      font-weight: 750;
    }
    .wxDetail{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.10);
      color: var(--fg);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 700;
      cursor:pointer;
      white-space:nowrap;
      height: fit-content;
      align-self: end;
    }
    .btn:active{transform: translateY(1px);}

    .mid{
      position:relative;
      border-radius: 24px;
      background:
        radial-gradient(1200px 520px at 50% 115%, rgba(120,180,255,.18), transparent 60%),
        radial-gradient(900px 420px at 15% 120%, rgba(120,255,200,.12), transparent 60%),
        radial-gradient(800px 380px at 85% 120%, rgba(255,140,200,.10), transparent 60%),
        rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    canvas{position:absolute; inset:0; width:100%; height:100%;}
    .corner{
      position:absolute;
      right: 14px;
      bottom: 14px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    @media (max-width: 900px){
      .clock .time{font-size: 74px;}
      .card{min-width: 240px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="clock">
        <div class="time" id="time">--:--</div>
        <div class="date" id="date">----</div>
      </div>

      <div class="rightPanel">
        <div class="card" id="weatherCard">
          <div class="label">WEATHER</div>
          <div class="weatherRow">
            <div class="wxMain">
              <div class="wxIcon" id="wxIcon">‚õÖÔ∏è</div>
              <div class="wxText">
                <div class="wxTemp" id="wxTemp">--¬∞C</div>
                <div class="wxPlace" id="wxPlace">‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®±ÂèØ„Åô„Çã„Å®Ë°®Á§∫</div>
                <div class="wxDetail" id="wxDetail">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <button class="btn" id="openChatGPT">ChatGPT</button>
      </div>
    </div>

    <div class="mid">
      <canvas id="c"></canvas>
      <div class="corner"></div>
    </div>
  </div>

<script>
(() => {
  // ---------- CLOCK ----------
  const timeEl = document.getElementById("time");
  const dateEl = document.getElementById("date");
  const pad = (n)=>String(n).padStart(2,"0");
  const dow = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];
  function tick(){
    const d = new Date();
    timeEl.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    dateEl.textContent = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} (${dow[d.getDay()]})`;
  }
  tick(); setInterval(tick, 1000);

  // ---------- BUTTON ----------
  document.getElementById("openChatGPT").addEventListener("click", ()=>{
    window.open("https://chatgpt.com", "_blank");
  });

  // ---------- WEATHER (Open-Meteo, no API key) ----------
  const wxIconEl = document.getElementById("wxIcon");
  const wxTempEl = document.getElementById("wxTemp");
  const wxPlaceEl = document.getElementById("wxPlace");
  const wxDetailEl = document.getElementById("wxDetail");

  function weatherEmoji(code){
    // Open-Meteo WMO weather code
    if(code === 0) return "‚òÄÔ∏è";
    if([1,2].includes(code)) return "üå§Ô∏è";
    if(code === 3) return "‚òÅÔ∏è";
    if([45,48].includes(code)) return "üå´Ô∏è";
    if([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
    if([61,63,65,66,67].includes(code)) return "üåßÔ∏è";
    if([71,73,75,77].includes(code)) return "üå®Ô∏è";
    if([80,81,82].includes(code)) return "üåßÔ∏è";
    if([85,86].includes(code)) return "üå®Ô∏è";
    if([95,96,99].includes(code)) return "‚õàÔ∏è";
    return "‚õÖÔ∏è";
  }
  function codeText(code){
    const m = new Map([
      [0,"Âø´Êô¥"],[1,"Êô¥„Çå"],[2,"Êô¥„ÇåÊôÇ„ÄÖÊõá„Çä"],[3,"Êõá„Çä"],
      [45,"Èúß"],[48,"Èúß"],
      [51,"ÈúßÈõ®(Âº±)"],[53,"ÈúßÈõ®(‰∏≠)"],[55,"ÈúßÈõ®(Âº∑)"],
      [56,"ÂáçÁµêÈúßÈõ®(Âº±)"],[57,"ÂáçÁµêÈúßÈõ®(Âº∑)"],
      [61,"Èõ®(Âº±)"],[63,"Èõ®(‰∏≠)"],[65,"Èõ®(Âº∑)"],
      [66,"ÂáçÁµêÈõ®(Âº±)"],[67,"ÂáçÁµêÈõ®(Âº∑)"],
      [71,"Èõ™(Âº±)"],[73,"Èõ™(‰∏≠)"],[75,"Èõ™(Âº∑)"],[77,"Èú∞(„ÅÇ„Çâ„Çå)"],
      [80,"„Å´„Çè„ÅãÈõ®(Âº±)"],[81,"„Å´„Çè„ÅãÈõ®(‰∏≠)"],[82,"„Å´„Çè„ÅãÈõ®(Âº∑)"],
      [85,"„Å´„Çè„ÅãÈõ™(Âº±)"],[86,"„Å´„Çè„ÅãÈõ™(Âº∑)"],
      [95,"Èõ∑Èõ®"],[96,"Èõ∑Èõ®(Èõπ)"],[99,"Èõ∑Èõ®(Èõπ)"]
    ]);
    return m.get(code) ?? `Â§©Ê∞ó„Ç≥„Éº„Éâ ${code}`;
  }

  async function fetchWeather(lat, lon){
    // current weather + temp/wind
    const url =
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,weather_code,wind_speed_10m` +
      `&timezone=Asia%2FTokyo`;
    const r = await fetch(url);
    if(!r.ok) throw new Error("weather fetch failed");
    return r.json();
  }

  async function reverseGeocode(lat, lon){
    // Open-Meteo Geocoding (reverse)
    const url =
      `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=ja`;
    const r = await fetch(url);
    if(!r.ok) return null;
    const j = await r.json();
    const p = j?.results?.[0];
    if(!p) return null;
    // ‰æã: "Êù±‰∫¨ÈÉΩ, Êó•Êú¨"
    const parts = [p.admin1, p.country].filter(Boolean);
    return parts.join(", ");
  }

  function setWxLoading(msg){
    wxPlaceEl.textContent = msg;
    wxDetailEl.textContent = "‚Äî";
    wxTempEl.textContent = "--¬∞C";
    wxIconEl.textContent = "‚õÖÔ∏è";
  }

  async function updateWeather(){
    if(!navigator.geolocation){
      setWxLoading("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÈùûÂØæÂøú");
      return;
    }
    setWxLoading("‰ΩçÁΩÆÊÉÖÂ†±„ÅÆË®±ÂèØÂæÖ„Å°‚Ä¶");
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const [wx, place] = await Promise.all([
          fetchWeather(lat, lon),
          reverseGeocode(lat, lon)
        ]);

        const cur = wx.current;
        const temp = Math.round(cur.temperature_2m);
        const code = cur.weather_code;
        const wind = Math.round(cur.wind_speed_10m);

        wxIconEl.textContent = weatherEmoji(code);
        wxTempEl.textContent = `${temp}¬∞C`;
        wxPlaceEl.textContent = place ?? `lat ${lat.toFixed(2)}, lon ${lon.toFixed(2)}`;
        wxDetailEl.textContent = `${codeText(code)} / È¢® ${wind}m/s`;

      }catch(e){
        setWxLoading("Â§©Ê∞ó„ÅÆÂèñÂæó„Å´Â§±ÊïóÔºà„Éç„ÉÉ„ÉàÁ¢∫Ë™çÔºâ");
      }
    }, (err)=>{
      // permission denied etc.
      setWxLoading("‰ΩçÁΩÆÊÉÖÂ†±OFFÔºàË®≠ÂÆö‚ÜíSafari‚Üí‰ΩçÁΩÆÊÉÖÂ†±Ôºâ");
    }, { enableHighAccuracy:false, timeout:8000, maximumAge: 10*60*1000 });
  }

  updateWeather();
  // 10ÂàÜ„Åî„Å®„Å´Êõ¥Êñ∞
  setInterval(updateWeather, 10*60*1000);

  // ---------- PIXEL CHARACTER ----------
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: true });

  function resize(){
    const r = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width * r);
    canvas.height = Math.floor(rect.height * r);
    ctx.setTransform(r,0,0,r,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  const palettes = [
    { body:"#9BE9A8", dark:"#2D6A4F", eye:"#070b10", blush:"#FF6B9A" },
    { body:"#A0C4FF", dark:"#364FC7", eye:"#070b10", blush:"#FFB703" },
    { body:"#FFD6A5", dark:"#E76F51", eye:"#070b10", blush:"#FF006E" }
  ];
  let pal = palettes[0];

  const state = { x: 120, y: 0, vx: 70, dir: 1, t: 0 };

  function drawSprite(x, y, scale, frame){
    const s = scale;
    const px = (ix,iy,col)=>{
      ctx.fillStyle = col;
      ctx.fillRect(x + ix*s, y + iy*s, s, s);
    };

    const body = pal.body, dark = pal.dark, eye = pal.eye, blush = pal.blush;

    const mask = [
      "....######......",
      "...########.....",
      "..##########....",
      ".############...",
      ".############...",
      ".############...",
      ".############...",
      ".############...",
      "..##########....",
      "..##########....",
      "...########.....",
      "....######......",
      ".....####.......",
      "......##........",
      "................",
      "................",
    ];

    const ears = [{x:5,y:1},{x:10,y:1},{x:4,y:2},{x:11,y:2}];
    const legOffset = Math.round(Math.sin(frame*0.08)*1);
    const legs = [{x:5,y:12+legOffset},{x:10,y:12-legOffset}];

    for(let iy=0; iy<16; iy++){
      for(let ix=0; ix<16; ix++){
        if(mask[iy][ix] === "#"){
          const shade = (ix+iy > 18) ? dark : body;
          px(ix,iy,shade);
        }
      }
    }

    ears.forEach(p => px(p.x,p.y,dark));

    const blink = (Math.sin(frame*0.015) > 0.993);
    if(!blink){
      px(6,6,eye); px(9,6,eye);
      px(6,5,"rgba(255,255,255,.85)");
      px(9,5,"rgba(255,255,255,.85)");
    }else{
      px(6,6,eye); px(7,6,eye);
      px(9,6,eye); px(10,6,eye);
    }

    px(5,8,blush); px(10,8,blush);

    if(Math.sin(frame*0.03) > 0){
      px(7,9,eye); px(8,9,eye);
    }else{
      px(7,9,eye);
    }

    legs.forEach(p => px(p.x,p.y, dark));
  }

  function stars(W,H,t){
    const n = 70;
    for(let i=0;i<n;i++){
      const x = (i*97) % W;
      const y = (i*173) % H;
      const tw = (Math.sin(t*0.8 + i)*0.5 + 0.5);
      ctx.globalAlpha = 0.10 + tw*0.22;
      ctx.fillStyle = "white";
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;
  }

  // long press / double tap to change palette (no on-screen hints)
  let lastTap = 0;
  document.querySelector(".mid").addEventListener("touchend", ()=>{
    const now = Date.now();
    if(now - lastTap < 350){
      const idx = palettes.indexOf(pal);
      pal = palettes[(idx+1) % palettes.length];
    }
    lastTap = now;
  });

  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;
    state.t += dt;

    const rect = canvas.getBoundingClientRect();
    const W = rect.width, H = rect.height;

    ctx.clearRect(0,0,W,H);

    // ground line
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "white";
    ctx.fillRect(0, H-44, W, 1);
    ctx.globalAlpha = 1;

    stars(W,H,state.t);

    state.x += state.vx * dt * state.dir;
    const margin = 60;
    if(state.x < margin){ state.x = margin; state.dir = 1; }
    if(state.x > W - margin){ state.x = W - margin; state.dir = -1; }

    const bob = Math.sin(state.t*3.0)*6;
    state.y = H*0.62 + bob;

    const scale = 6;
    const spriteW = 16*scale, spriteH = 16*scale;

    ctx.save();
    ctx.translate(state.x, state.y);
    ctx.scale(state.dir >= 0 ? 1 : -1, 1);
    drawSprite(-spriteW/2, -spriteH/2, scale, now);
    ctx.restore();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
